/*
 * This file is part of HuDK.
 * ASM and C open source software development kit for the NEC PC Engine.
 * Licensed under the MIT License
 * (c) 2016-2020 MooZ
 */

#include "hudk.h"

#define SPRITES_DATA_VRAM_ADDR 0x1800

#incbin(sprites_pal, "data/palette.bin")

#incbin(ball0, "data/ball0.bin")
#incbin(ball1, "data/ball1.bin")
#incbin(ball2, "data/ball2.bin")
#incbin(ball3, "data/ball3.bin")
#incbin(ball4, "data/ball4.bin")
#incbin(ball5, "data/ball5.bin")
#incbin(ball6, "data/ball6.bin")
#incbin(ball7, "data/ball7.bin")

// sine and cosine tables [0,16[
const char sin_table[256] = {
    0x00,0x01,0x02,0x02,0x03,0x04,0x05,0x05,0x06,0x07,0x08,0x09,0x09,0x0a,0x0b,0x0c,
    0x0c,0x0d,0x0e,0x0e,0x0f,0x10,0x10,0x11,0x12,0x12,0x13,0x14,0x14,0x15,0x15,0x16,
    0x17,0x17,0x18,0x18,0x19,0x19,0x1a,0x1a,0x1b,0x1b,0x1b,0x1c,0x1c,0x1d,0x1d,0x1d,
    0x1e,0x1e,0x1e,0x1e,0x1f,0x1f,0x1f,0x1f,0x1f,0x1f,0x1f,0x1f,0x1f,0x1f,0x1f,0x1f,
    0x1f,0x1f,0x1f,0x1f,0x1f,0x1f,0x1f,0x1f,0x1f,0x1f,0x1f,0x1f,0x1f,0x1e,0x1e,0x1e,
    0x1e,0x1d,0x1d,0x1d,0x1c,0x1c,0x1b,0x1b,0x1b,0x1a,0x1a,0x19,0x19,0x18,0x18,0x17,
    0x17,0x16,0x15,0x15,0x14,0x14,0x13,0x12,0x12,0x11,0x10,0x10,0x0f,0x0e,0x0e,0x0d,
    0x0c,0x0c,0x0b,0x0a,0x09,0x09,0x08,0x07,0x06,0x05,0x05,0x04,0x03,0x02,0x02,0x01,
    0x00,0xff,0xfe,0xfe,0xfd,0xfc,0xfb,0xfb,0xfa,0xf9,0xf8,0xf7,0xf7,0xf6,0xf5,0xf4,
    0xf4,0xf3,0xf2,0xf2,0xf1,0xf0,0xf0,0xef,0xee,0xee,0xed,0xec,0xec,0xeb,0xeb,0xea,
    0xe9,0xe9,0xe8,0xe8,0xe7,0xe7,0xe6,0xe6,0xe5,0xe5,0xe5,0xe4,0xe4,0xe3,0xe3,0xe3,
    0xe2,0xe2,0xe2,0xe2,0xe1,0xe1,0xe1,0xe1,0xe1,0xe0,0xe0,0xe0,0xe0,0xe0,0xe0,0xe0,
    0xe0,0xe0,0xe0,0xe0,0xe0,0xe0,0xe0,0xe0,0xe1,0xe1,0xe1,0xe1,0xe1,0xe2,0xe2,0xe2,
    0xe2,0xe3,0xe3,0xe3,0xe4,0xe4,0xe5,0xe5,0xe5,0xe6,0xe6,0xe7,0xe7,0xe8,0xe8,0xe9,
    0xe9,0xea,0xeb,0xeb,0xec,0xec,0xed,0xee,0xee,0xef,0xf0,0xf0,0xf1,0xf2,0xf2,0xf3,
    0xf4,0xf4,0xf5,0xf6,0xf7,0xf7,0xf8,0xf9,0xfa,0xfb,0xfb,0xfc,0xfd,0xfe,0xfe,0xff
};

const char sprite_size[8] = {
    VDC_SPRITE_WIDTH_32 | VDC_SPRITE_HEIGHT_32,
    VDC_SPRITE_WIDTH_32 | VDC_SPRITE_HEIGHT_32,
    VDC_SPRITE_WIDTH_32 | VDC_SPRITE_HEIGHT_32,
    VDC_SPRITE_WIDTH_32 | VDC_SPRITE_HEIGHT_32,
    VDC_SPRITE_WIDTH_16 | VDC_SPRITE_HEIGHT_16,
    VDC_SPRITE_WIDTH_16 | VDC_SPRITE_HEIGHT_16,
    VDC_SPRITE_WIDTH_16 | VDC_SPRITE_HEIGHT_16,
    VDC_SPRITE_WIDTH_16 | VDC_SPRITE_HEIGHT_16
};

const int sprite_addr[8] = {
    SPRITES_DATA_VRAM_ADDR,
    SPRITES_DATA_VRAM_ADDR + 0x100,
    SPRITES_DATA_VRAM_ADDR + 0x200,
    SPRITES_DATA_VRAM_ADDR + 0x300,
    SPRITES_DATA_VRAM_ADDR + 0x400,
    SPRITES_DATA_VRAM_ADDR + 0x440,
    SPRITES_DATA_VRAM_ADDR + 0x480,
    SPRITES_DATA_VRAM_ADDR + 0x4c0
};

const char sprite_dy[8] = {
    0x40, 0x40, 0x40, 0x40,
    0x48, 0x48, 0x48, 0x48
};

const char sprite_phase[8] = {
    0,20,40,60,80,100,120,140
};

char t;

void main() {
    char i;
    char angle;
    int addr;
    char y;

    irq_disable(INT_ALL);

    // set BAT size
    vdc_set_bat_size(VDC_BG_64x32);

    // load sprites palette
    vce_load_palette(16, 1, sprites_pal);

    // load sprites gfx
    vdc_load_data(SPRITES_DATA_VRAM_ADDR, ball0, 2560);

    // Set scroll window.
    scroll_set(0, 0, 254, 0, 0, VDC_CR_BG_ENABLE | VDC_CR_SPR_ENABLE | VDC_CR_VBLANK_ENABLE | VDC_CR_HBLANK_ENABLE | 0x01);

    vdc_reg(VDC_DMA_CR);
    vdc_write(VDC_DMA_SAT_AUTO | VDC_DMA_SATB_ENABLE);

    vdc_sat_addr(0x7000);

    // enable IRQ 1.
    irq_enable(INT_IRQ1);

    for(;;) {
        for(i=0; i<8; i++) {
            spr_x(i, i<<5);
            
            angle = t + sprite_phase[i];
            y = sprite_dy[i] + sin_table[angle];
            spr_y(i, y);

            spr_pattern(i, sprite_addr[i]);
            
            spr_pal(i, 0);

            spr_pri(i, 1);

            spr_ctrl(i, VDC_SPRITE_WIDTH_MASK | VDC_SPRITE_HEIGHT_MASK, sprite_size[i]);

            t++;
        }
        // wait for vsync
        vdc_wait_vsync();
        spr_update_satb();
    }
}
